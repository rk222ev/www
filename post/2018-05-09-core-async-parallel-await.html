<!doctype html><html><head><meta charset="UTF-8" /><meta content="ie=edge" http-equiv="x-ua-compatible" /><meta content="" name="description" /><meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" /><title>rpkn.se - Awaiting parallel executions with core.async</title><link href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css" rel="stylesheet" type="text/css" /><link href="/default.css" rel="stylesheet" type="text/css" /></head><body><div id="wrap"><div id="header"><h1><a href="">rpkn.se</a></h1><div id="navigation"><ul><li><a href="/index.html">Home</a></li><li><a href="/about.html">About</a></li></ul></div></div><div class="content"></div><h1>Awaiting parallel executions with core.async</h1><p>
Playing around with core.async I stumbled into a small problem when
I tried to perform some parallel work using threads and block until all
threads were completed.
</p>

<p>
To illustrate the problem I'll use a small helper function: <code>make-threads</code>
</p>

<div class="org-src-container">
<pre class="src src-clojure">(defn make-threads
  []
  [(thread (Thread/sleep 3000)
	   (println "3000"))
   (thread
     (do (Thread/sleep 20)
	 (println "20")))
   (thread
     (do (Thread/sleep 1000)
	 (println "1000")))] )
</pre>
</div>

<p>
Not blocking will return <code>:done</code> and then <code>println</code> from each thread as they complete.
</p>

<div class="org-src-container">
<pre class="src src-clojure">(let [p (make-threads)]
  :done )
;; =&gt; :done
;; =&gt; 20
;; =&gt; 1000
;; =&gt; 3000
</pre>
</div>

<p>
In order to block and await <code>make-threads</code> to perform its work one can use <code>mapv</code> and <code>&lt;!!</code>.
This will iterate and block on each channel returned by <code>thread</code>.
</p>

<div class="org-src-container">
<pre class="src src-clojure">(let [p (mapv &lt;!! (make-threads))]
 :done)
;; =&gt; 20
;; =&gt; 1000
;; =&gt; 3000
;; =&gt; :done
</pre>
</div>

<p>
Note that <code>map</code> will not work.
</p>

<div class="org-src-container">
<pre class="src src-clojure">(let [p (map &lt;!! (make-threads))]
  :done)
;; =&gt; :done
;; =&gt; 20
;; =&gt; 1000
;; =&gt; 3000
</pre>
</div>
<div id="icons"><ul><li><a href="https://github.com/rpkarlsson"><img alt="My Github" src="/images/GitHub-Mark-32px.png" /></a></li><li><a href="https://twitter.com/ropkn"><img alt="My Twitter" src="/images/TwitterLogo.png" /></a></li></ul></div><script src="/js/main.js"></script></div></body></html>